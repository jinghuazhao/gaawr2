---
title: "CSL URL Checking and Citation Example"
author: "ChatGPT"
output: html_document
bibliography: REFERENCES.bib
csl: !r gaawr2::check_csl_urls_in_memory("path/to/your/citation-style-file.csl")
vignette: >
  %\VignetteIndexEntry{gaawr2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{httr, xml2}
---

```{r csl}
# Load necessary libraries
if (!requireNamespace("httr", quietly = TRUE)) install.packages("httr")
if (!requireNamespace("xml2", quietly = TRUE)) install.packages("xml2")

library(httr)
library(xml2)

# Function to check if a URL is valid (returns TRUE if valid, FALSE otherwise)
check_url_status <- function(url) {
  response <- tryCatch(httr::HEAD(url), error = function(e) NULL)
  if (!is.null(response) && httr::status_code(response) == 200) {
    return(TRUE)
  } else {
    return(FALSE)
  }
}

# Function to check and update URLs in a CSL content string (in memory)
check_csl_urls_in_memory <- function(csl_content) {
  # Parse the CSL content directly from memory (XML object)
  csl_doc <- xml2::read_xml(csl_content)
  
  # Extract all the <link> elements' href attributes
  link_nodes <- xml2::xml_find_all(csl_doc, "//link/@href")
  
  # Loop through each link and check its status
  for (node in link_nodes) {
    url <- xml2::xml_text(node)
    if (!check_url_status(url)) {
      # If the URL is broken, replace it with a fallback message
      xml2::xml_text(node) <- "URL not available"
    }
  }
  
  # Return the modified CSL XML object (not a string yet)
  return(csl_doc)
}

# Function to extract links from the CSL content (in memory)
extract_csl_links_from_memory <- function(csl_doc) {
  # Extract all the <link> elements' href attributes from the XML object
  link_nodes <- xml2::xml_find_all(csl_doc, "//link/@href")
  return(xml2::xml_text(link_nodes))
}

# Function to convert CSL XML to string when needed
convert_csl_to_string <- function(csl_doc) {
  return(xml2::xml_text(csl_doc))  # Corrected to use xml_text() instead of as.character()
}

# Read the CSL content into memory (from a file or as a string)
csl_content <- readLines("nature-genetics.csl", warn = FALSE)
csl_content <- paste(csl_content, collapse = "\n")

# Process the CSL content in memory (check and update URLs)
csl_doc <- check_csl_urls_in_memory(csl_content)

# Optionally, print the modified CSL content (converted to a string)
modified_csl_content <- convert_csl_to_string(csl_doc)

# Extract and print the links from the modified CSL content
links <- extract_csl_links_from_memory(csl_doc)
cat("Links in CSL file:\n")
print(links)
```

Would this work @malone10?

## References
